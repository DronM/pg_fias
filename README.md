# Классификатор адресов ФИАС для Postgresql
Загрузка классификатора [ФИАС](https://fias.nalog.ru/) в базу данных Postgresql для организации ввода адресов до дома.

## Порядок установки:
Открыть скрипт pg_fias.sh и произвести настройки:
- Определить схему базы данных для загрузки, по умолчанию fias. Схема должна существовать в базе на момент загрузки. Пользователь должен иметь полный доступ к объектам схемы.
- Настроить данные для подключения к базе данных PG.
- Определить, что будет загружаться: дельта или все данные. Закоментировать одну из комманд get
- Определить список регионов для загрузки.

## Описание работы скрипта:
- Автоматически выкачиваются файлы **ФИАС** с сайта налоговой. Выкачивается либо дельта либо полный файл, распаковываются необходимые регионы. Загрузка и распаковка выполняются во временной папке внутри папки с исполняемым скриптом. По оканчанию временная папка удаляется со всем содержимым.
- Загружаесть файл с сокращениями **SOCRBASE.DBF** и индексируется для точного поиска по сокращению.
- Загружаются все файлы по анному списку регионов: **ADDROB*.DBF** и **HOUSE*.DBF**. Все файлы по регионам в базе объединяются в общие таблицы **addrobj** и **house** соответственно.
- Имеющиеся в базе данных таблицы на момент загрузки не удаляютя. Т.о. если необходима загрузка с *чистого листа* предварительно нужно удалить все таблицы из базы данных.
- Дополнительно создаются следующие объекты базы данных:
	- Функция формирования адресной строки для aoguid адреса **aoguid_address(in_aguid text)**. Возвращает JSON объект со следующей информацией:
		- *search_name* - объединенная строка для поиска адреса
		- *addr_struc* - массив с информацией ФИАС по адресу (aolevel,aoguid,shortname,offname,regioncode)
	- Материализованные представление со строкой поиска по адресам **address_search** с индексом для поиска LIKE	
	- Материализованные представление со строкой поиска по домам **house_search** с индексом для поиска LIKE
	- Расширение **pg_trgm** для организации поиска *LIKE*
	- Вспомогательная функция поикса find_address(text,int)
	
## Использование
- Адреса
	SELECT * FROM fias.address_search WHERE search_name ilike '%СТРОКА_ПОИСКА%' limit 10
- Дома
	SELECT * FROM fias.house_search WHERE search_name ilike '%СТРОКА_ПОИСКА%' limit 10
- Через вспомогательную функцию: адреса + дома, всего не более задонного количества строк
	SELECT * FROM fias.find_address('%СТРОКА_ПОИСКА%',10)
